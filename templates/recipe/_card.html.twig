{# templates/recipe/_card.html.twig #}
{% set recipe = view.recipe %}
{% set recipeImg = recipe_image(recipe) %}
{% set missingItems = view.items|filter(i => i.is_missing ?? false) %}
{% set missingCount = missingItems|length %}

<a href="{{ path('app_recipe_show', { id: recipe.id }) }}"
   class="rp-recipe-item text-decoration-none text-reset"
   aria-label="Ouvrir la recette {{ recipe.name }}">
  <div class="rp-recipe-main">
    <div class="rp-recipe-left">
      <img
        src="{{ recipeImg }}"
        alt="{{ recipe.name }}"
        class="rp-recipe-thumb"
        width="44" height="44"
        loading="lazy"
        decoding="async"
      />

      <div class="rp-recipe-meta">
        <div class="rp-recipe-title text-truncate">{{ recipe.name }}</div>

        {% if is_feasible %}
          <div class="rp-recipe-sub">Tous les ingrédients sont disponibles.</div>
        {% else %}
          <div class="rp-recipe-sub">
            {{ missingCount }} ingrédient{{ missingCount > 1 ? 's' : '' }} manquant{{ missingCount > 1 ? 's' : '' }}
          </div>
        {% endif %}
      </div>
    </div>

    <div class="rp-recipe-right">
      {% if is_feasible %}
        <span class="rp-pill rp-pill-ok">OK</span>
      {% else %}
        <span class="rp-pill rp-pill-miss">Manque</span>
      {% endif %}

      <span class="rp-chevron" aria-hidden="true">
        <i class="fa-solid fa-chevron-right"></i>
      </span>
    </div>
  </div>

  {# Détails uniquement si non faisable #}
  {% if not is_feasible %}
    <div class="rp-recipe-details">
      {% if missingCount == 0 %}
        <div class="rp-recipe-sub">Détails indisponibles.</div>
      {% else %}
        <ul class="rp-missing-list">
          {% set maxLines = 3 %}
          {% for item in missingItems|slice(0, maxLines) %}
            {% set ing = item.ingredient %}
            {% set unit = item.unitLabel ?? (item.unit is defined and item.unit ? item.unit.value : '') %}

            <li class="rp-missing-row">
              <div class="rp-missing-left">
                {% if ing %}
                  <img
                    src="{{ ingredient_image(ing) }}"
                    alt="{{ ing.name }}"
                    class="rp-missing-thumb"
                    width="22" height="22"
                    loading="lazy"
                    decoding="async"
                  />
                  <span class="text-truncate">{{ ing.name }}</span>
                {% else %}
                  <span class="text-muted">Ingrédient supprimé</span>
                {% endif %}
              </div>

              <div class="rp-missing-right">
                {% if item.needed is null %}
                  <span class="text-muted">—</span>
                {% else %}
                  <span class="rp-pill rp-pill-miss">
                    Manque {{ item.missing_amount|default(0)|round(2) }}{% if unit %} {{ unit }}{% endif %}
                  </span>
                {% endif %}
              </div>
            </li>
          {% endfor %}

          {% if missingCount > maxLines %}
            <li class="rp-missing-more">
              +{{ missingCount - maxLines }} autre{{ (missingCount - maxLines) > 1 ? 's' : '' }}
            </li>
          {% endif %}
        </ul>
      {% endif %}
    </div>
  {% endif %}
</a>
