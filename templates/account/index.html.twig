{% extends 'base.html.twig' %}

{% block title %}Mon compte — {{ parent() }}{% endblock %}

{% block body %}
  <div class="d-flex align-items-center justify-content-between mt-3 mb-3">
    <div>
      <h1 class="h4 mb-1">Mon compte</h1>
      <div class="text-body-secondary small">Gère ton profil, tes préférences et tes réglages.</div>
    </div>
  </div>

  <div class="row g-3 pb-5">

    {# Colonne gauche : navigation #}
    <aside class="col-12 col-lg-3">
      <div class="card">
        <div class="card-body">
          <div class="d-lg-block" style="position: sticky; top: 90px;">
            <div class="list-group" id="account-nav">
              <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="#profil" data-anchor>
                <i class="fa-solid fa-id-card"></i>
                <span>Profil</span>
              </a>
              <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="#preferences" data-anchor>
                <i class="fa-solid fa-sliders"></i>
                <span>Préférences</span>
              </a>
              <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="#notifications" data-anchor>
                <i class="fa-solid fa-bell"></i>
                <span>Notifications</span>
              </a>
              <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" href="#securite" data-anchor>
                <i class="fa-solid fa-shield-halved"></i>
                <span>Sécurité</span>
              </a>
            </div>

            <div class="mt-3 d-grid gap-2">
              <a class="btn btn-outline-danger" href="{{ path('app_logout') }}">
                <i class="fa-solid fa-right-from-bracket me-2"></i>
                Se déconnecter
              </a>
            </div>
          </div>
        </div>
      </div>
    </aside>

    {# Colonne droite : contenu #}
    <section class="col-12 col-lg-9">
      <div class="card">
        <div class="card-body">

          {# Helper: évite que le header sticky masque le titre quand on clique une ancre #}
          <style>
            .rp-anchor {
              scroll-margin-top: 110px;
            }
          </style>

          {# ===================== PROFIL ===================== #}
          <div id="profil" class="rp-anchor">
            <div class="d-flex align-items-start justify-content-between gap-3">
              <div>
                <h2 class="h5 mb-1">Profil</h2>
                <p class="text-body-secondary small mb-0">Informations principales du compte.</p>
              </div>
            </div>

            <hr class="my-3">

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" value="{{ app.user.email }}" disabled>
                <div class="form-text">Pour changer l’email : prévoir un flow de confirmation.</div>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Statut email</label>
                {% if app.user.isVerified %}
                  <div class="alert alert-success mb-0">Email confirmé ✅</div>
                {% else %}
                  <div class="alert alert-warning mb-0">Email non confirmé</div>
                {% endif %}
              </div>

              <div class="col-12">
                <button class="btn btn-primary" disabled>Enregistrer</button>
                <div class="text-body-secondary small mt-2">
                  Branche ensuite sur un Symfony Form (profile) + handler.
                </div>
              </div>
            </div>
          </div>

          <hr class="my-4">

          {# ===================== PRÉFÉRENCES ===================== #}
          <div id="preferences" class="rp-anchor">
            <h2 class="h5 mb-1">Préférences</h2>
            <p class="text-body-secondary small">Réglages de confort et comportement de l’app.</p>

            <hr class="my-3">

            <form method="post">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">Langue</label>
                  <select class="form-select" name="locale" disabled>
                    <option value="fr-FR" selected>Français (France)</option>
                  </select>
                  <div class="form-text">Brancher sur User.locale (et AiContext) si tu ajoutes ce champ.</div>
                </div>

                <div class="col-12 col-md-6">
                  <label class="form-label">Mode debug IA</label>
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="debugIa" disabled>
                    <label class="form-check-label" for="debugIa">Afficher le payload (dev)</label>
                  </div>
                </div>

                <div class="col-12">
                  <button class="btn btn-primary" disabled>Enregistrer</button>
                </div>
              </div>
            </form>
          </div>

          <hr class="my-4">

          {# ===================== NOTIFICATIONS ===================== #}
          <div id="notifications" class="rp-anchor">
            <h2 class="h5 mb-1">Notifications</h2>
            <p class="text-body-secondary small">Push PWA et rappels proactifs.</p>

            <hr class="my-3">

            <div
              class="border rounded p-3"
              data-controller="push-toggle"
              data-push-toggle-vapid-public-key-value="{{ vapid_public_key }}"
              data-push-toggle-subscribe-url-value="{{ path('push_subscribe') }}"
              data-push-toggle-unsubscribe-url-value="{{ path('push_unsubscribe') }}"
            >
              <div class="d-flex align-items-center justify-content-between gap-3">
                <div>
                  <div class="fw-semibold">Notifications push</div>
                  <div class="text-muted small" data-push-toggle-target="status">Chargement…</div>
                </div>

                <div class="form-check form-switch m-0">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    role="switch"
                    id="pushToggle"
                    data-push-toggle-target="toggle"
                    data-action="push-toggle#toggleChanged"
                  >
                </div>
              </div>
            </div>

          </div>

          <hr class="my-4">

          {# ===================== SÉCURITÉ ===================== #}
          <div id="securite" class="rp-anchor">
            <h2 class="h5 mb-1">Sécurité</h2>
            <p class="text-body-secondary small">Mot de passe, accès et sessions.</p>

            <hr class="my-3">

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">Mot de passe</label>
                <a class="btn btn-outline-dark w-100" href="{{ path('account_change_password') }}">
                  Réinitialiser le mot de passe
                </a>
              </div>

              <div class="col-12 col-md-6">
                <label class="form-label">Déconnexion</label>
                <a class="btn btn-outline-danger w-100" href="{{ path('app_logout') }}">
                  Se déconnecter
                </a>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

  </div>

  {# Optionnel: “active state” dans la nav en fonction du scroll #}
  <script>
    (function () {
      const nav = document.getElementById('account-nav');
      if (!nav) return;

      const links = Array.from(nav.querySelectorAll('a[data-anchor]'));
      const sections = links
        .map(a => document.querySelector(a.getAttribute('href')))
        .filter(Boolean);

      function setActiveById(id) {
        links.forEach(a => {
          const isActive = a.getAttribute('href') === '#' + id;
          a.classList.toggle('active', isActive);
        });
      }

      // Active sur click
      links.forEach(a => {
        a.addEventListener('click', () => {
          const id = a.getAttribute('href').slice(1);
          setActiveById(id);
        });
      });

      // Active au scroll (IntersectionObserver)
      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries) => {
          const visible = entries
            .filter(e => e.isIntersecting)
            .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
          if (visible && visible.target && visible.target.id) {
            setActiveById(visible.target.id);
          }
        }, { rootMargin: '-120px 0px -70% 0px', threshold: [0.1, 0.2, 0.5] });

        sections.forEach(s => io.observe(s));
      } else {
        // Fallback simple
        setActiveById('profil');
      }
    })();
  </script>
{% endblock %}
