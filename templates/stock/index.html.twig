{% extends 'base.html.twig' %}

{% block title %}Stock{% endblock %}

{% block body %}
<div class="py-4">
  <div class="d-flex align-items-center justify-content-between mb-3 gap-2 flex-wrap">
    <h1 class="h3 mb-0">Mon stock</h1>

    <div class="d-flex gap-2 flex-wrap">

      {# 2) Ajouter manuellement (toggle collapse) #}
      <button
        class="btn btn-primary d-flex align-items-center gap-2"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#stockUpsertForm"
        aria-expanded="{{ form.vars.submitted ? 'true' : 'false' }}"
        aria-controls="stockUpsertForm"
      >
        <i class="fa-solid fa-plus"></i>
        <span class="d-none d-sm-inline">Ajouter manuellement</span>
        <span class="d-inline d-sm-none">Manuel</span>
      </button>

      {# 3) Ajouter via l’assistant #}
      <a href="{{ path('assistant') }}"
         class="btn btn-outline-secondary d-flex align-items-center gap-2">
        <i class="fa-solid fa-microphone"></i>
        <span class="d-none d-sm-inline">Ajouter via l’assistant</span>
        <span class="d-inline d-sm-none">Assistant</span>
      </a>
    </div>
  </div>

  {# Flash messages #}
  {% for label, messages in app.flashes %}
    {% for message in messages %}
      <div class="alert alert-{{ label }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endfor %}

  {# ===== Formulaire Ajouter / Mettre à jour (masqué par défaut) ===== #}
  <div id="stockUpsertForm"
       class="collapse mb-4 {% if form.vars.submitted %}show{% endif %}">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h6 mb-3">Ajouter / mettre à jour</h2>

        {{ form_start(form, { action: path('stock_upsert'), method: 'POST' }) }}
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-7">
              {{ form_label(form.ingredient) }}
              {{ form_widget(form.ingredient, { attr: { class: 'form-control' } }) }}
              {{ form_errors(form.ingredient) }}
            </div>

            <div class="col-12 col-md-3">
              {{ form_label(form.quantity) }}
              <div class="input-group">
                {{ form_widget(form.quantity, { attr: { class: 'form-control' } }) }}
                <span class="input-group-text">—</span>
              </div>
              {{ form_errors(form.quantity) }}
            </div>

            <div class="col-12 col-md-2 d-grid">
              <button class="btn btn-primary" type="submit">Enregistrer</button>
            </div>
          </div>
        {{ form_end(form) }}
      </div>
    </div>
  </div>

  {# ===== Liste du stock ===== #}
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="h6 mb-0">Liste</h2>
        <span class="badge text-bg-light">{{ items|length }}</span>
      </div>

      {% if items is empty %}
        <div class="text-muted">Aucun ingrédient en stock.</div>
      {% else %}

        {# ===== Mobile: swipe to reveal delete (xs/sm) ===== #}
        <div class="d-grid gap-2 d-md-none">
          {% for ui in items %}
            {% set ing = ui.ingredient %}
            {% set unit = (ing and ing.unit) ? ing.unit.value : '' %}

            <div
              class="swipe-item {% if loop.first %}swipe-hint{% endif %}"
              data-controller="swipe-reveal"
              data-swipe-reveal-open-class-value="is-revealed"
            >
              <div class="swipe-actions">
                <form
                  method="post"
                  action="{{ path('stock_delete', {id: ui.id}) }}"
                  onsubmit="return confirm('Supprimer cet ingrédient du stock ?');"
                >
                  <input type="hidden" name="_token" value="{{ csrf_token('delete_stock_' ~ ui.id) }}">
                  <button
                    class="btn btn-sm btn-outline-danger rp-icon-btn swipe-trash"
                    type="submit"
                    title="Supprimer"
                    aria-label="Supprimer"
                  >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </form>
              </div>

              <div class="swipe-content">
                <div class="d-flex align-items-center justify-content-between gap-2">
                  <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width:0;">
                    <img
                      src="{{ ingredient_image(ing) }}"
                      alt="{{ ing.name }}"
                      width="24"
                      height="24"
                      loading="lazy"
                      decoding="async"
                      style="object-fit: contain; border-radius: 8px;"
                    >
                    <div class="text-truncate">
                      <span class="fw-semibold">{{ ing.name }}</span>
                      {% if unit %}
                        <span class="text-muted"> · {{ unit }}</span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="text-end flex-shrink-0">
                    <span class="fw-bold">{{ ui.quantity }}</span>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        {# ===== Desktop/tablet: table (md+) ===== #}
        <div class="table-responsive d-none d-md-block">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th>Ingrédient</th>
                <th class="text-end">Quantité</th>
                <th class="text-end">Unité</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>

            <tbody>
              {% for ui in items %}
                {% set ing = ui.ingredient %}
                <tr>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <img
                        src="{{ ingredient_image(ing) }}"
                        alt="{{ ing.name }}"
                        width="24"
                        height="24"
                        loading="lazy"
                        style="object-fit: contain; border-radius: 6px;"
                      >
                      <span>{{ ing.name }}</span>
                    </div>
                  </td>

                  <td class="text-end">{{ ui.quantity }}</td>

                  <td class="text-end">
                    {{ (ing and ing.unit) ? ing.unit.value : '' }}
                  </td>

                  <td class="text-end">
                    <form method="post"
                          action="{{ path('stock_delete', {id: ui.id}) }}"
                          class="d-inline"
                          onsubmit="return confirm('Supprimer cet ingrédient du stock ?');">
                      <input type="hidden" name="_token" value="{{ csrf_token('delete_stock_' ~ ui.id) }}">
                      <button class="btn btn-sm btn-outline-danger rp-icon-btn" type="submit" title="Supprimer" aria-label="Supprimer">
                        <i class="fa-solid fa-trash"></i>
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>

      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
