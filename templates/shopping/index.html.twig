{% extends 'base.html.twig' %}

{% block title %}Liste de courses{% endblock %}

{% block body %}
  <div
    data-controller="shopping"
    data-shopping-toggle-url-value="{{ path('shopping_toggle', { id: 0 }) }}"
    data-shopping-validate-url-value="{{ path('shopping_validate_cart') }}"
    data-shopping-update-quantity-url-value="{{ path('shopping_update_quantity', { id: 0 }) }}"
    data-shopping-csrf-token-value="{{ csrf_token('shopping_cart') }}"
  >
    <div class="d-flex justify-content-between align-items-center mb-3 gap-2 flex-wrap">
      <h1 class="mb-0">üß∫ Courses</h1>

      <div class="d-flex align-items-center gap-2 flex-wrap">
        <a
          href="{{ path('shopping_generate') }}"
          class="btn btn-outline-primary d-flex align-items-center gap-2"
          title="G√©n√©rer ma liste d'ingr√©dient n√©cessaire a mes recettes"
        >
          <i class="fa-solid fa-receipt"></i>
          <span class="d-none d-sm-inline">G√©n√©rer ma liste</span>
        </a>

        <button
          type="button"
          class="btn btn-primary d-flex align-items-center gap-2"
          data-shopping-target="validateBtn"
          data-action="shopping#validateCart"
          disabled
          title="Valider les produits coch√©s et les ajouter au stock"
        >
          <i class="fa-solid fa-cart-shopping"></i>
          <span class="d-none d-sm-inline">Valider mon caddie</span>
          <span class="d-inline d-sm-none">Valider</span>
        </button>
      </div>
    </div>


    <div class="rp-section-title mb-3">
      <h2 class="mb-0">Liste</h2>
      <span class="badge bg-primary rp-count-badge">{{ items|length }}</span>
    </div>
    

    {% if items is empty %}
      <div class="text-center text-muted py-4">
        Ta liste de courses est vide üßò‚Äç‚ôÄÔ∏è
      </div>
    {% else %}

      {# ===== Mobile: swipe to reveal delete (xs/sm) ===== #}
      <div class="d-grid gap-2 d-md-none">
        {% for item in items %}
          {% set checked = item.checked is defined and item.checked %}
          {% set ing = item.ingredient %}
          {% set unit = (ing and ing.unit) ? ing.unit.value : '' %}

          <div
            class="swipe-item {{ checked ? 'opacity-50' : '' }} {% if loop.first %}swipe-hint{% endif %}"
            data-shopping-row-id="{{ item.id }}"
            data-controller="swipe-reveal"
            data-swipe-reveal-open-class-value="is-revealed"
          >
            <div class="swipe-actions">
              <button
                type="button"
                class="btn btn-sm btn-outline-danger swipe-trash"
                data-action="shopping#remove"
                data-shopping-id-param="{{ item.id }}"
                aria-label="Supprimer"
                title="Supprimer"
              >
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>

            <div class="swipe-content">
              <div class="d-flex align-items-center justify-content-between gap-2">
                <div class="d-flex align-items-center gap-2 flex-grow-1" style="min-width:0;">
                  <input
                    type="checkbox"
                    class="form-check-input m-0"
                    data-shopping-target="checkbox"
                    data-action="change->shopping#toggle"
                    data-shopping-id-param="{{ item.id }}"
                    {% if checked %}checked{% endif %}
                    aria-label="Cocher l‚Äôarticle"
                  >

                  <img
                    src="{{ ingredient_image(ing) }}"
                    alt="{{ ing.name }}"
                    width="50"
                    height="50"
                    loading="lazy"
                    decoding="async"
                    style="object-fit: contain; border-radius: 8px;"
                  >

                  <div class="text-truncate">
                    <span class="fw-semibold">{{ ing.name|capitalize }}</span>
                    {% if unit %}
                      <span class="text-muted"> ¬∑ {{ unit }}</span>
                    {% endif %}
                  </div>
                </div>

                <div class="flex-shrink-0" style="width: 64px;">
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control form-control-sm text-end"
                    value="{{ item.quantity }}"
                    data-action="change->shopping#updateQuantity"
                    data-shopping-id-param="{{ item.id }}"
                    title="Modifier la quantit√© (0 = retirer de la liste)"
                    aria-label="Quantit√©"
                  >
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {# ===== Desktop/tablet: table (md+) ===== #}
      <div class="table-responsive d-none d-md-block">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 44px;"></th>
              <th>Ingr√©dient</th>
              <th class="text-nowrap" style="width: 140px;">Quantit√©</th>
              <th>Unit√©</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for item in items %}
              {% set checked = item.checked is defined and item.checked %}
              {% set ing = item.ingredient %}

              <tr data-shopping-row-id="{{ item.id }}" class="{{ checked ? 'opacity-50' : '' }}">
                <td>
                  <input
                    type="checkbox"
                    class="form-check-input"
                    data-shopping-target="checkbox"
                    data-action="change->shopping#toggle"
                    data-shopping-id-param="{{ item.id }}"
                    {% if checked %}checked{% endif %}
                  >
                </td>

                <td>
                  <div class="d-flex align-items-center gap-2">
                    <img
                      src="{{ ingredient_image(ing) }}"
                      alt="{{ ing.name }}"
                      width="50"
                      height="50"
                      loading="lazy"
                      style="object-fit: contain; border-radius: 6px;"
                    >
                    <span>{{ ing.name|capitalize }}</span>
                  </div>
                </td>

                <td class="text-nowrap">
                  <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="form-control form-control-sm"
                    value="{{ item.quantity }}"
                    data-action="change->shopping#updateQuantity"
                    data-shopping-id-param="{{ item.id }}"
                    title="Modifier la quantit√© (0 = retirer de la liste)"
                  >
                </td>

                <td>
                  {{ (ing and ing.unit) ? ing.unit.value : '' }}
                </td>

                <td class="text-end">
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger"
                    data-action="shopping#remove"
                    data-shopping-id-param="{{ item.id }}"
                    title="Supprimer"
                    aria-label="Supprimer"
                  >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    {% endif %}
      
  </div>
{% endblock %}
