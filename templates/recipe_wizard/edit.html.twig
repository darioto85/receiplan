{# templates/recipe_wizard/edit.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Modifier recette{% endblock %}

{% block body %}
  {% set recipeImg = recipe_image(recipe) %}
  {% if not recipeImg %}
    {% set recipeImg = asset('img/recipe/placeholder.png') %}
  {% endif %}

  <div
    class="card shadow-sm"
    data-controller="recipe-wizard recipe-ingredients recipe-steps"
    data-recipe-wizard-save-draft-url-value="{{ path('recipe_wizard_save_draft') }}"
    data-recipe-wizard-recipe-id-value="{{ recipe.id }}"
    data-recipe-wizard-preview-url-value="{{ path('recipe_wizard_preview', { id: recipe.id }) }}"

    data-recipe-ingredients-upsert-url-value="{{ path('recipe_wizard_ingredient_upsert', { id: recipe.id }) }}"
    data-recipe-ingredients-preview-url-value="{{ path('recipe_wizard_preview', { id: recipe.id }) }}"

    data-recipe-steps-add-url-value="{{ path('recipe_wizard_step_add', { id: recipe.id }) }}"
  >
    <div class="card-body">

      {# HEADER #}
      <div class="d-flex align-items-center justify-content-between mb-3 gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-3" style="min-width:0;">
          <img
            src="{{ recipeImg }}"
            alt="{{ recipe.name }}"
            width="56"
            height="56"
            loading="lazy"
            decoding="async"
            style="object-fit: contain; background:#fff; border-radius: 14px;"
          >
          <h1 class="mb-0 text-truncate" style="max-width: min(70vw, 640px);">
            {{ recipe.name ?: 'Recette' }}
          </h1>
        </div>

        {# ✅ Bouton contextuel : step1/2 => modifier nom ; step3 => retour ingrédients #}
        <div class="d-flex gap-2">
          <button
            type="button"
            class="btn btn-outline-primary"
            data-action="recipe-wizard#goStep1"
            data-recipe-wizard-target="headerToStep1"
          >
            Modifier le nom
          </button>

          <button
            type="button"
            class="btn btn-outline-primary is-hidden"
            data-action="recipe-wizard#goStep2"
            data-recipe-wizard-target="headerToStep2"
          >
            ← Retour aux ingrédients
          </button>
        </div>
      </div>

      <div class="text-muted mb-4" data-recipe-wizard-target="stepHint">
        Étape 1/4 — Nom
      </div>

      {# STEP 1 #}
      <section class="rp-step" data-recipe-wizard-target="step1">
        <div class="mb-2" data-recipe-wizard-target="step1Error"></div>

        <form data-action="submit->recipe-wizard#submitStep1" class="rp-quickadd">
          <div class="rp-quickadd__bar">
            <div class="rp-quickadd__field">
              <input
                type="text"
                class="rp-quickadd__input"
                placeholder="Nom de la recette"
                autocomplete="off"
                required
                value="{{ recipe.name }}"
                data-recipe-wizard-target="nameInput"
              >
            </div>

            <button type="submit" class="rp-quickadd__btn">
              <span>Valider</span>
              <span class="rp-quickadd__btnChevron">›</span>
            </button>
          </div>
        </form>

        <div class="d-flex justify-content-end mt-3">
          <button type="button" class="btn btn-outline-primary" data-action="recipe-wizard#goStep2">
            Passer aux ingrédients →
          </button>
        </div>
      </section>

      {# STEP 2 — INGREDIENTS #}
      <section class="rp-step is-hidden" data-recipe-wizard-target="step2">

        <div class="mb-2" data-recipe-ingredients-target="formErrors"></div>

        {{ form_start(form, {
          action: path('recipe_wizard_ingredient_upsert', { id: recipe.id }),
          method: 'POST',
          attr: {
            class: 'rp-quickadd',
            'data-action': 'submit->recipe-ingredients#submitUpsert'
          }
        }) }}
          <div class="rp-quickadd__bar">
            <div class="rp-quickadd__field">
              {{ form_widget(form.ingredient, { attr: { class: 'rp-quickadd__input', placeholder: 'Ajouter rapidement' } }) }}
              {{ form_errors(form.ingredient) }}
            </div>

            <div class="rp-quickadd__mini">
              {{ form_widget(form.quantity, { attr: { class: 'rp-quickadd__miniInput', placeholder: 'Qté…', inputmode: 'decimal' } }) }}
              {{ form_errors(form.quantity) }}
            </div>

            <div class="rp-quickadd__mini">
              <div class="rp-quickadd__miniFake" aria-hidden="true">—</div>
            </div>

            <button type="submit" class="rp-quickadd__btn">
              <span class="rp-quickadd__btnIcon">+</span>
              <span>Ajouter</span>
              <span class="rp-quickadd__btnChevron">›</span>
            </button>
          </div>
        {{ form_end(form) }}

        <div class="mt-3" data-recipe-ingredients-target="listing">
          {{ include('recipe_wizard/_ingredient_listing.html.twig', { recipe: recipe }) }}
        </div>

        <div class="d-flex justify-content-end mt-4">
          {% if recipe.draft %}
            <button type="button" class="btn btn-primary" data-action="recipe-wizard#goStep3">
              Continuer
            </button>
          {% else %}
            <a href="{{ path('app_recipe_show', { id: recipe.id }) }}" class="btn btn-primary">
              Terminer → Voir la recette
            </a>
          {% endif %}
        </div>
      </section>

      {# STEP 3 — STEPS (RecipeStep) #}
      <section class="rp-step is-hidden" data-recipe-wizard-target="step3">

        <div class="mb-2" data-recipe-steps-target="formError"></div>

        <form class="mb-3" data-action="submit->recipe-steps#submitAdd">
          <div class="mb-2">
            <textarea
              class="form-control"
              rows="3"
              placeholder="Décris une étape… (ex: Faire revenir les oignons 5 min)"
              data-recipe-steps-target="content"
            ></textarea>
          </div>

          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-outline-primary">
              + Ajouter une étape
            </button>
          </div>
        </form>

        <div data-recipe-steps-target="listing">
          {{ include('recipe_wizard/_step_listing.html.twig', { recipe: recipe }) }}
        </div>

        <div class="d-flex justify-content-end mt-4">
          <a href="{{ path('recipe_wizard_preview', { id: recipe.id }) }}" class="btn btn-primary">
            Continuer
          </a>
        </div>
      </section>

      {# ===== Delete Modal + Quantity Modal ingrédients (inchangés) ===== #}
      <div
        class="modal fade"
        id="recipeIngredientDeleteModal"
        tabindex="-1"
        aria-hidden="true"
        data-recipe-ingredients-target="deleteModal"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content rp-modal">
            <div class="modal-header border-0 pb-0">
              <h5 class="modal-title d-flex align-items-center gap-2">
                <img src="{{ asset('img/actions/delete.png') }}" alt="" width="22" height="22" style="object-fit:contain;">
                Supprimer l’ingrédient
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>

            <div class="modal-body pt-2">
              <div class="rp-modal-text">
                Tu es sûr de vouloir supprimer
                <span class="fw-bold" data-recipe-ingredients-target="deleteName">cet ingrédient</span>
                ?
              </div>

              <div class="mt-3" data-recipe-ingredients-target="deleteError"></div>
            </div>

            <div class="modal-footer border-0 pt-0">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
              <button
                type="button"
                class="btn btn-danger d-inline-flex align-items-center gap-2"
                data-action="recipe-ingredients#confirmDelete"
                data-recipe-ingredients-target="confirmDeleteBtn"
              >
                <span>Supprimer</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        class="modal fade"
        id="recipeIngredientQuantityModal"
        tabindex="-1"
        aria-hidden="true"
        data-recipe-ingredients-target="qtyModal"
      >
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content rp-modal">
            <div class="modal-header border-0 pb-0">
              <h5 class="modal-title">Modifier la quantité</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>

            <div class="modal-body pt-2">
              <div class="rp-modal-text">
                <span class="fw-bold" data-recipe-ingredients-target="qtyName">Ingrédient</span>
              </div>

              <div class="mt-3">
                <div class="input-group">
                  <input
                    type="text"
                    inputmode="decimal"
                    class="form-control fw-bold"
                    placeholder="Ex: 250"
                    data-recipe-ingredients-target="qtyModalInput"
                    data-action="focus->recipe-ingredients#clearQtyOnFocus click->recipe-ingredients#clearQtyOnFocus"
                  >
                  <span class="input-group-text fw-bold" data-recipe-ingredients-target="qtyUnit">unité</span>
                </div>
              </div>

              <div class="mt-3" data-recipe-ingredients-target="qtyError"></div>
            </div>

            <div class="modal-footer border-0 pt-0">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
              <button
                type="button"
                class="btn btn-primary"
                data-action="recipe-ingredients#confirmQtyModal"
                data-recipe-ingredients-target="qtyConfirmBtn"
              >
                Enregistrer
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
{% endblock %}
