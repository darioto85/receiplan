{# templates/recipe_wizard/preview.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}R√©capitulatif{% endblock %}

{% block body %}
  {# ‚úÖ image recette (helper existant) avec fallback placeholder #}
  {% set recipeImg = recipe_image(recipe) %}
  {% if not recipeImg %}
    {% set recipeImg = asset('img/recipe/placeholder.png') %}
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body">

      {# =========================
         HEADER : image recette + titre "R√©capitulatif" + bouton retour (seul bouton retour)
         ========================= #}
      <div class="d-flex align-items-center justify-content-between mb-3 gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-3" style="min-width:0;">
          <img
            src="{{ recipeImg }}"
            alt="{{ recipe.name }}"
            width="56"
            height="56"
            loading="lazy"
            decoding="async"
            style="object-fit: contain; background:#fff; border-radius: 14px;"
          >
          <h1 class="mb-0">R√©capitulatif</h1>
        </div>

        <a href="{{ path('recipe_wizard_edit', { id: recipe.id }) }}?step=3" class="btn btn-outline-primary">
          ‚Üê Retour
        </a>
      </div>

      {# ===== Nom de la recette ===== #}
      <div class="mb-4">
        <div class="text-muted small mb-1">Nom</div>
        <div class="h4 mb-0">{{ recipe.name }}</div>
      </div>

      <hr class="my-4">

      {# ===== Ingr√©dients ===== #}
      <div class="mb-3 d-flex align-items-center justify-content-between gap-2 flex-wrap">
        <h2 class="h5 mb-0">üßÇ Ingr√©dients</h2>
      </div>

      {% set items = recipe.recipeIngredients %}

      {% if items is empty %}
        <div class="text-muted">Aucun ingr√©dient.</div>
      {% else %}
        <div class="list-group mb-4">
          {% for ri in items %}
            {% set ing = ri.ingredient %}
            {% set unit = (ing and ing.unit) ? ing.unit.value : '' %}
            <div class="list-group-item d-flex align-items-center justify-content-between gap-3">
              <div class="d-flex align-items-center gap-2" style="min-width:0;">
                <img
                  src="{{ ingredient_image(ing) }}"
                  alt="{{ ing.name }}"
                  width="42"
                  height="42"
                  loading="lazy"
                  style="object-fit: contain; border-radius: 8px;"
                >
                <div class="text-truncate">
                  <div class="fw-semibold">{{ ing.name|capitalize }}</div>
                  {% if unit %}
                    <div class="text-muted small">{{ unit }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="fw-bold text-nowrap">
                {{ ri.quantity }}
                {% if unit %} {{ unit }}{% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <hr class="my-4">

      {# ===== √âtapes ===== #}
      <div class="mb-3 d-flex align-items-center justify-content-between gap-2 flex-wrap">
        <h2 class="h5 mb-0">üìù √âtapes</h2>
      </div>

      {% set steps = recipe.recipeSteps %}

      {% if steps is empty %}
        <div class="text-muted mb-4">Aucune √©tape.</div>
      {% else %}
        <div class="list-group mb-4">
          {% for step in steps %}
            <div class="list-group-item">
              <div class="d-flex align-items-start gap-2">
                <span class="badge text-bg-light mt-1">#{{ step.position }}</span>
                <div class="text-break">{{ step.content }}</div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {# ===== CTA ===== #}
      {% if recipe.draft %}
        <form method="post" action="{{ path('recipe_wizard_publish', { id: recipe.id }) }}" class="d-flex justify-content-end">
          <input type="hidden" name="_token" value="{{ csrf_token('recipe_publish_' ~ recipe.id) }}">
          <button type="submit" class="btn btn-primary">
            Enregistrer la recette
          </button>
        </form>
      {% else %}
        <div class="d-flex justify-content-end">
          <a href="{{ path('app_recipe_show', { id: recipe.id }) }}" class="btn btn-primary">
            Voir la recette
          </a>
        </div>
      {% endif %}

    </div>
  </div>
{% endblock %}
