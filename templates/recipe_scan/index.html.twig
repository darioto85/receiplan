{% extends 'base.html.twig' %}

{% block title %}Scanner une recette{% endblock %}

{% block body %}

  <h1 class="mb-0">
    <img class="rp-title-thumb" src="{{ asset('img/actions/photo.png') }}" alt="">
    Scanner une recette
  </h1>
  <div class="rp-scan-sub">Une photo suffit. Kuko s‚Äôoccupe du reste.</div>
  <div class="rp-scan-note">Rien n‚Äôest enregistr√© sans ton accord.</div>

  {# ===== ZONE UPLOAD ===== #}
  <div class="rp-scan-body">
    <form method="post"
          action="{{ path('recipe_scan_upload') }}"
          enctype="multipart/form-data"
          class="rp-scan-form"
          id="rp-scan-form">
      <input type="hidden" name="_token" value="{{ csrf_token('recipe_scan_upload') }}">

      {# Zone ‚Äúdrop‚Äù cliquable #}
      <label class="rp-scan-drop" for="rp-scan-photo" id="rp-scan-drop">
        <div class="rp-scan-illus" aria-hidden="true">
          <div class="rp-scan-illus-fallback">
            <img
              id="rp-scan-illus-img"
              src="{{ asset('img/actions/charger_recette.jpg') }}"
              data-empty-src="{{ asset('img/actions/charger_recette.jpg') }}"
              data-filled-src="{{ asset('img/actions/recette_chargee.jpg') }}"
              alt=""
            />
          </div>
        </div>

        <div class="rp-scan-drop-title" id="rp-scan-title">D√©pose une photo de la recette</div>
        <div class="rp-scan-drop-sub" id="rp-scan-sub">ou prends-la directement avec ton t√©l√©phone</div>

        <div class="rp-scan-hint" id="rp-scan-hint">
          Astuce : une photo nette aide Kuko √† mieux comprendre, mais fais au mieux üíö
        </div>

        <div class="rp-scan-file" id="rp-scan-file" hidden>
          <span class="rp-scan-file-badge">‚úÖ Photo pr√™te</span>
          <span class="rp-scan-file-name" id="rp-scan-file-name"></span>
        </div>
      </label>

      <input
        id="rp-scan-photo"
        class="rp-scan-input"
        type="file"
        name="photo"
        accept="image/*"
        capture="environment"
        required
      >

      <div class="rp-scan-actions">
        <button type="submit" class="btn btn-primary rp-scan-btn" id="rp-scan-submit" disabled>
          Analyser la recette
        </button>
      </div>
    </form>

    {% if last_upload %}
      <div class="rp-scan-divider"></div>

      <div class="rp-scan-uploaded">
        <div class="rp-scan-uploaded-meta">
          <div class="rp-scan-uploaded-title">Derni√®re photo envoy√©e</div>
          <div class="rp-scan-uploaded-file text-truncate">{{ last_upload.originalName }}</div>
          <div class="rp-scan-uploaded-info">
            {{ last_upload.mime }} ‚Ä¢ {{ last_upload.uploadedAt }}
          </div>
        </div>

        <div class="rp-scan-uploaded-cta">
          <form method="post" action="{{ path('recipe_scan_analyze') }}">
            <input type="hidden" name="_token" value="{{ csrf_token('recipe_scan_analyze') }}">
            <button class="btn btn-success rp-scan-btn">
              ü§ñ Analyser
            </button>
          </form>

          <form method="post" action="{{ path('recipe_scan_reset') }}">
            <input type="hidden" name="_token" value="{{ csrf_token('recipe_scan_reset') }}">
            <button class="btn btn-outline-danger rp-scan-btn">
              üóëÔ∏è Supprimer
            </button>
          </form>
        </div>
      </div>
    {% endif %}
  </div>

  {# ===== BOTTOM "manual" ===== #}
  <div class="rp-scan-footer">
    <div class="rp-scan-footer-label">Tu pr√©f√®res faire autrement ?</div>
    <a href="{{ path('recipe_wizard_new') }}" class="rp-scan-pill">
      <span class="rp-scan-pill-ico" aria-hidden="true">‚úèÔ∏è</span>
      Saisir la recette manuellement
    </a>
  </div>

  <script>
    (function () {
      const input = document.getElementById('rp-scan-photo');
      const drop = document.getElementById('rp-scan-drop');
      const img = document.getElementById('rp-scan-illus-img');
      const fileWrap = document.getElementById('rp-scan-file');
      const fileName = document.getElementById('rp-scan-file-name');
      const submit = document.getElementById('rp-scan-submit');

      if (!input || !drop || !img || !fileWrap || !fileName || !submit) return;

      function setEmpty() {
        drop.classList.remove('is-filled');

        img.src = img.dataset.emptySrc || img.src;

        // Affiche les textes
        document.getElementById('rp-scan-title').hidden = false;
        document.getElementById('rp-scan-sub').hidden = false;
        document.getElementById('rp-scan-hint').hidden = false;

        // Cache l‚Äô√©tat fichier
        fileWrap.hidden = true;
        fileName.textContent = '';

        submit.disabled = true;
      }

      function setFilled(file) {
        drop.classList.add('is-filled');

        img.src = img.dataset.filledSrc || img.src;

        // Cache les textes
        document.getElementById('rp-scan-title').hidden = true;
        document.getElementById('rp-scan-sub').hidden = true;
        document.getElementById('rp-scan-hint').hidden = true;

        // Affiche l‚Äô√©tat fichier
        fileWrap.hidden = false;
        fileName.textContent = file?.name ? '‚Äî ' + file.name : '';

        submit.disabled = false;
      }


      setEmpty();

      input.addEventListener('change', function () {
        const file = input.files && input.files[0] ? input.files[0] : null;
        if (!file) return setEmpty();
        setFilled(file);
      });

      document.getElementById('rp-scan-form')?.addEventListener('submit', function () {
        const btn = document.getElementById('rp-scan-submit');
        if (!btn) return;
        btn.disabled = true;
        btn.textContent = 'Analyse en cours‚Ä¶';
      });
    })();
  </script>

{% endblock %}
