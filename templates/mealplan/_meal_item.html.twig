{# templates/mealplan/_meal_item.html.twig #}
{% set ok = is_feasible ?? true %}
{% set hint = swipe_hint ?? false %}
{% set recipe = meal.recipe %}
{% set recipeImg = recipe ? recipe_image(recipe) : null %}

<div data-meal-id="{{ meal.id }}">
  {# =========================
     MOBILE (swipe enabled)
     ========================= #}
  <div class="d-md-none">
    <div
      class="swipe-item {% if hint %}swipe-hint{% endif %}"
      data-controller="swipe-reveal"
      data-swipe-reveal-open-class-value="is-revealed"
    >
      {% if not meal.validated %}
        <div class="swipe-actions">
          <button
            type="button"
            class="rp-action-btn swipe-trash"
            data-controller="meal-delete"
            data-meal-delete-url-value="{{ path('meal_plan_delete_ajax', { id: meal.id }) }}"
            data-meal-delete-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}"
            data-action="meal-delete#remove"
            title="Supprimer le repas"
            aria-label="Supprimer le repas"
          >
            <img
              src="{{ asset('img/actions/delete.png') }}"
              alt="Supprimer"
              class="rp-action-thumb"
            >
          </button>
        </div>
      {% endif %}

      <div class="swipe-content border rounded rp-meal-card">
        <div class="rp-meal-row"
             data-controller="meal-plan"
             data-meal-plan-url-validate-value="{{ path('recipe_validate', { id: meal.id }) }}"
             data-meal-plan-url-cancel-value="{{ path('recipe_cancel', { id: meal.id }) }}"
             data-meal-plan-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}">

          <div class="rp-meal-main">
            {% if recipe and recipeImg %}
              <img
                src="{{ recipeImg }}"
                alt="{{ recipe.name }}"
                class="rp-meal-thumb"
                loading="lazy"
                decoding="async"
              >
            {% endif %}

            <div class="rp-meal-meta">
              <div class="rp-meal-title">
                {{ recipe ? recipe.name : 'Recette supprimée' }}
              </div>

              {% if recipe and not meal.validated and not ok %}
                <span class="badge text-bg-warning mt-1">Stock insuffisant</span>
              {% endif %}
            </div>
          </div>

          <div class="rp-meal-actions">
            {% if meal.validated %}
              <button
                type="button"
                class="rp-action-btn"
                data-action="meal-plan#cancel"
                title="Annuler la validation"
                aria-label="Annuler la validation"
              >
                <img
                  src="{{ asset('img/actions/recette_valide.png') }}"
                  alt="Repas validé"
                  class="rp-action-thumb"
                >
              </button>
            {% else %}
              <button
                type="button"
                class="rp-action-btn"
                data-action="meal-plan#validate"
                title="Valider le repas"
                aria-label="Valider le repas"
              >
                <img
                  src="{{ asset('img/actions/recette_nonvalide.png') }}"
                  alt="Valider le repas"
                  class="rp-action-thumb"
                >
              </button>

              <button
                type="button"
                class="rp-action-btn"
                data-controller="meal-refresh"
                data-meal-refresh-url-value="{{ path('meal_plan_refresh_ajax', { id: meal.id }) }}"
                data-meal-refresh-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}"
                data-action="meal-refresh#refresh"
                title="Changer la recette"
                aria-label="Changer la recette"
              >
                <img
                  src="{{ asset('img/actions/actualiser.png') }}"
                  alt="Actualiser"
                  class="rp-action-thumb"
                >
              </button>
            {% endif %}
          </div>

        </div>
      </div>
    </div>
  </div>

  {# =========================
     DESKTOP
     ========================= #}
  <div class="d-none d-md-block">
    {# IMPORTANT: wrapper position:relative + class "rp-meal-card--desktop" #}
    <div class="border rounded rp-meal-card rp-meal-card--desktop">
      {% if not meal.validated %}
        {# Delete overlay (desktop only, show on hover) #}
        <button
          type="button"
          class="rp-action-btn rp-meal-delete"
          data-controller="meal-delete"
          data-meal-delete-url-value="{{ path('meal_plan_delete_ajax', { id: meal.id }) }}"
          data-meal-delete-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}"
          data-action="meal-delete#remove"
          title="Supprimer le repas"
          aria-label="Supprimer le repas"
        >
          <img
            src="{{ asset('img/actions/delete.png') }}"
            alt=""
            class="rp-action-thumb rp-action-thumb--delete"
          >
        </button>
      {% endif %}

      <div class="rp-meal-row"
           data-controller="meal-plan"
           data-meal-plan-url-validate-value="{{ path('recipe_validate', { id: meal.id }) }}"
           data-meal-plan-url-cancel-value="{{ path('recipe_cancel', { id: meal.id }) }}"
           data-meal-plan-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}">

        <div class="rp-meal-main">
          {% if recipe and recipeImg %}
            <img
              src="{{ recipeImg }}"
              alt="{{ recipe.name }}"
              class="rp-meal-thumb"
              loading="lazy"
              decoding="async"
            >
          {% endif %}

          <div class="rp-meal-meta">
            <div class="rp-meal-title">
              {{ recipe ? recipe.name : 'Recette supprimée' }}
            </div>

            {% if recipe and not meal.validated and not ok %}
              <span class="badge text-bg-warning mt-1">Stock insuffisant</span>
            {% endif %}
          </div>
        </div>

        {# Actions desktop (sans delete ici) #}
        <div class="rp-meal-actions">
          {% if meal.validated %}
            <button
              type="button"
              class="rp-action-btn"
              data-action="meal-plan#cancel"
              title="Annuler la validation"
              aria-label="Annuler la validation"
            >
              <img
                src="{{ asset('img/actions/recette_valide.png') }}"
                alt="Repas validé"
                class="rp-action-thumb"
              >
            </button>
          {% else %}
            <button
              type="button"
              class="rp-action-btn"
              data-action="meal-plan#validate"
              title="Valider le repas"
              aria-label="Valider le repas"
            >
              <img
                src="{{ asset('img/actions/recette_nonvalide.png') }}"
                alt="Valider le repas"
                class="rp-action-thumb"
              >
            </button>

            <button
              type="button"
              class="rp-action-btn"
              data-controller="meal-refresh"
              data-meal-refresh-url-value="{{ path('meal_plan_refresh_ajax', { id: meal.id }) }}"
              data-meal-refresh-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}"
              data-action="meal-refresh#refresh"
              title="Changer la recette"
              aria-label="Changer la recette"
            >
              <img
                src="{{ asset('img/actions/actualiser.png') }}"
                alt="Actualiser"
                class="rp-action-thumb"
              >
            </button>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>
