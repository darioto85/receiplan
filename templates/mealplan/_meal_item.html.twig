{# templates/mealplan/_meal_item.html.twig #}
{% set ok = is_feasible ?? true %}
{% set hint = swipe_hint ?? false %}
{% set recipe = meal.recipe %}
{% set recipeImg = recipe ? recipe_image(recipe) : null %}

{# =========================
   MOBILE (swipe enabled)
   ========================= #}
<div class="d-md-none">
  <div
    class="swipe-item {% if hint %}swipe-hint{% endif %}"
    data-meal-id="{{ meal.id }}"
    data-controller="swipe-reveal"
    data-swipe-reveal-open-class-value="is-revealed"
  >
    {# Actions révélées au swipe : uniquement si non validé #}
    {% if not meal.validated %}
      <div class="swipe-actions">
        <button
          type="button"
          class="btn btn-sm btn-outline-danger rp-icon-btn swipe-trash"
          title="Supprimer"
          aria-label="Supprimer"
          data-controller="meal-delete"
          data-meal-delete-url-value="{{ path('meal_plan_delete_ajax', { id: meal.id }) }}"
          data-meal-delete-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}"
          data-meal-delete-target="button"
          data-action="meal-delete#remove"
        >
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    {% endif %}

    <div class="swipe-content border rounded px-3 py-2">
      <div class="d-flex align-items-start justify-content-between gap-3">

        <div class="d-flex align-items-start gap-2 flex-grow-1" style="min-width:0;">
          {% if recipe and recipeImg %}
            <img
              src="{{ recipeImg }}"
              alt="{{ recipe.name }}"
              width="28"
              height="28"
              loading="lazy"
              decoding="async"
              style="object-fit: contain; border-radius: 8px; background:#fff;"
            >
          {% endif %}

          <div class="d-flex flex-column" style="min-width:0;">
            <div class="fw-semibold text-truncate">
              {{ recipe ? recipe.name : 'Recette supprimée' }}
              {% if recipe and not meal.validated and not ok %}
                <span class="badge text-bg-warning ms-2">Stock insuffisant</span>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="text-end d-flex align-items-center gap-2 flex-shrink-0"
             data-controller="meal-plan"
             data-meal-plan-url-validate-value="{{ path('recipe_validate', { id: meal.id }) }}"
             data-meal-plan-url-cancel-value="{{ path('recipe_cancel', { id: meal.id }) }}"
             data-meal-plan-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}">

          {% if meal.validated %}
            <span class="badge text-bg-success">Validé</span>
            <button type="button" class="btn btn-sm btn-outline-danger ms-2 rp-icon-btn" data-action="meal-plan#cancel">
              <i class="fa-solid fa-arrow-rotate-left"></i>
            </button>
          {% else %}
            <button type="button" class="btn btn-sm btn-outline-success" data-action="meal-plan#validate">
              Valider
            </button>

            <button type="button"
                    class="btn btn-sm btn-outline-secondary rp-icon-btn"
                    data-controller="meal-refresh"
                    data-meal-refresh-url-value="{{ path('meal_plan_refresh_ajax', { id: meal.id }) }}"
                    data-meal-refresh-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}"
                    data-action="meal-refresh#refresh">
              <i class="fa-solid fa-arrows-rotate"></i>
            </button>
          {% endif %}
        </div>

      </div>
    </div>
  </div>
</div>

{# =========================
   DESKTOP (no swipe)
   ========================= #}
<div class="d-none d-md-block">
  <div class="d-flex align-items-start justify-content-between gap-3 border rounded px-3 py-2"
       data-meal-id="{{ meal.id }}">

    <div class="d-flex align-items-start gap-2 flex-grow-1" style="min-width:0;">
      {% if recipe and recipeImg %}
        <img
          src="{{ recipeImg }}"
          alt="{{ recipe.name }}"
          width="28"
          height="28"
          loading="lazy"
          decoding="async"
          style="object-fit: contain; border-radius: 8px; background:#fff;"
        >
      {% endif %}

      <div class="d-flex flex-column" style="min-width:0;">
        <div class="fw-semibold text-truncate">
          {{ recipe ? recipe.name : 'Recette supprimée' }}
          {% if recipe and not meal.validated and not ok %}
            <span class="badge text-bg-warning ms-2">Stock insuffisant</span>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="text-end d-flex align-items-center gap-2 flex-shrink-0"
         data-controller="meal-plan"
         data-meal-plan-url-validate-value="{{ path('recipe_validate', { id: meal.id }) }}"
         data-meal-plan-url-cancel-value="{{ path('recipe_cancel', { id: meal.id }) }}"
         data-meal-plan-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}">

      {% if meal.validated %}
        <span class="badge text-bg-success">Validé</span>
        <button type="button" class="btn btn-sm btn-outline-danger ms-2 rp-icon-btn" data-action="meal-plan#cancel">
          <i class="fa-solid fa-arrow-rotate-left"></i>
        </button>
      {% else %}
        <button type="button" class="btn btn-sm btn-outline-success" data-action="meal-plan#validate">
          Valider
        </button>

        <button type="button"
                class="btn btn-sm btn-outline-secondary rp-icon-btn"
                data-controller="meal-refresh"
                data-meal-refresh-url-value="{{ path('meal_plan_refresh_ajax', { id: meal.id }) }}"
                data-meal-refresh-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}"
                data-action="meal-refresh#refresh">
          <i class="fa-solid fa-arrows-rotate"></i>
        </button>

        <button type="button"
                class="btn btn-sm btn-outline-danger rp-icon-btn"
                title="Supprimer"
                aria-label="Supprimer"
                data-controller="meal-delete"
                data-meal-delete-url-value="{{ path('meal_plan_delete_ajax', { id: meal.id }) }}"
                data-meal-delete-csrf-value="{{ csrf_token('mealplan_update_' ~ meal.id) }}"
                data-meal-delete-target="button"
                data-action="meal-delete#remove">
          <i class="fa-solid fa-trash"></i>
        </button>
      {% endif %}
    </div>
  </div>
</div>
