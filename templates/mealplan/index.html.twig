{# templates/mealplan/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Planning de repas{% endblock %}

{% block body %}

<div
  class="card p-3 mb-4"
  data-controller="push"
  data-push-target="card"
  data-push-vapid-public-key-value="{{ vapid_public_key }}"
  data-push-subscribe-url-value="{{ path('push_subscribe') }}"
  data-push-unsubscribe-url-value="{{ path('push_unsubscribe') }}"
>
  <div class="d-flex justify-content-between align-items-center gap-2">
    <div>
      <div class="fw-semibold">Notifications push</div>
      <div class="text-muted small" data-push-target="status">…</div>
    </div>
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-primary btn-sm" data-action="push#subscribe">
        Activer
      </button>
    </div>
  </div>
</div>

<div
  data-turbo="false"
  data-controller="agenda"
  data-agenda-week-url-value="{{ path('meal_plan_week') }}"
  data-agenda-initial-start-value="{{ weekStart|date('Y-m-d') }}"
  data-agenda-today-value="{{ 'now'|date('Y-m-d') }}"
>
  <noscript>
    <div class="alert alert-warning">
      Le planning en mode agenda nécessite JavaScript.
    </div>
  </noscript>

  {% for label, messages in app.flashes %}
    {% for message in messages %}
      <div class="alert alert-{{ label == 'error' ? 'danger' : label }} mb-3">
        {{ message }}
      </div>
    {% endfor %}
  {% endfor %}

  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
    <div>
      <h1 class="mb-1">
        <img class="rp-title-thumb" src="{{ asset('img/actions/planning.png') }}" alt="">
        Planning de repas
      </h1>
    </div>
  </div>

  {# Zone scrollable #}
  <div
    class="zone_meal_wrap rounded position-relative"
    style="height: calc(100vh - 220px); overflow: auto;"
    data-agenda-target="scroller"
  >
    <div data-agenda-target="error" class="alert alert-danger d-none m-3"></div>

    {# ✅ Overlay loader (remplace les textes) #}
    <div
      class="d-flex flex-column justify-content-center align-items-center gap-2 position-absolute top-0 start-0 w-100 h-100"
      style="background: rgba(255,255,255,.78); backdrop-filter: blur(2px); z-index: 20;"
      data-agenda-target="overlay"
    >
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div class="text-muted small">Chargement du planning…</div>
    </div>

    {# (on garde ces blocs si tu veux, mais ils restent cachés) #}
    <div data-agenda-target="loading" class="text-center text-body-secondary small my-3 d-none">
      Chargement de la semaine…
    </div>

    <div data-agenda-target="topSentinel" class="py-2 text-center text-body-secondary small d-none">
      ⬆️ Charger les semaines précédentes…
    </div>

    <div data-agenda-target="list" class="d-flex flex-column gap-3 pb-3">
      {# La semaine courante sera chargée en AJAX dès connect() #}
    </div>

    <div data-agenda-target="bottomSentinel" class="py-2 text-center text-body-secondary small d-none">
      ⬇️ Charger les semaines suivantes…
    </div>
  </div>
</div>

{# Modal recipe picker inchangée #}
<div
  class="modal fade"
  id="recipePickerModal"
  tabindex="-1"
  aria-hidden="true"
  data-controller="recipe-picker"
  data-recipe-picker-search-url-value="{{ path('meal_plan_recipe_search') }}"
  data-recipe-picker-assign-url-value="{{ path('meal_plan_assign_ajax') }}"
  data-recipe-picker-csrf-value="{{ csrf_token('mealplan_assign') }}"
>
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Choisir une recette</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input
          type="search"
          class="form-control mb-3"
          placeholder="Rechercher une recette…"
          data-action="input->recipe-picker#search"
          data-recipe-picker-target="query"
        />

        <div class="d-flex flex-column gap-2" data-recipe-picker-target="results">
          <div class="text-muted small">Tape pour rechercher…</div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
