{# templates/mealplan/week.html.twig #}
{% set todayKey = today|date('Y-m-d') %}

{# Hint : uniquement un repas non validé du jour, si présent dans cette semaine #}
{% set hintMealId = null %}
{% for i in 0..6 %}
  {% if hintMealId is null %}
    {% set day = weekStart|date_modify("+" ~ i ~ " days") %}
    {% set dayKey = day|date('Y-m-d') %}
    {% if dayKey == todayKey %}
      {% set mealsToday = planningByDate[dayKey] ?? [] %}
      {% for meal in mealsToday %}
        {% if hintMealId is null and not meal.validated %}
          {% set hintMealId = meal.id %}
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endif %}
{% endfor %}

<section class="card shadow-sm" data-week-start="{{ weekStart|date('Y-m-d') }}">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div class="fw-semibold">
      Semaine {{ weekStart|date('W') }} — {{ weekStart|date('d/m') }} → {{ weekEnd|date('d/m') }}
    </div>
  </div>

  <div class="card-body rp-card-body">
    <div class="rp-week-grid">
      {% for i in 0..6 %}
        {% set day = weekStart|date_modify("+" ~ i ~ " days") %}
        {% set dayKey = day|date('Y-m-d') %}
        {% set isToday = dayKey == todayKey %}
        {% set isPast = day < today %}
        {% set meals = planningByDate[dayKey] ?? [] %}

        {% set dayCardClasses = [
          'rp-day-card',
          isPast ? 'rp-day-card--past' : '',
          isToday ? 'rp-day-card--today' : ''
        ]|filter(v => v != '')|join(' ') %}

        <div class="{{ dayCardClasses }}">
          <div
            data-controller="day-propose recipe-picker"
            data-day-propose-url-value="{{ path('meal_plan_propose_ajax') }}"
            data-day-propose-date-value="{{ dayKey }}"
            data-day-propose-csrf-value="{{ csrf_token('mealplan_propose') }}"
            data-day-key="{{ dayKey }}"
            data-day="{{ dayKey }}"

            {# ✅ recipe picker endpoints (nouveaux) #}
            data-recipe-picker-search-url-value="{{ path('meal_plan_recipe_search') }}"
            data-recipe-picker-assign-url-value="{{ path('meal_plan_assign_ajax') }}"
            data-recipe-picker-csrf-value="{{ csrf_token('mealplan_assign') }}"
          >
            <div class="rp-day-head">
              <div class="rp-day-date {{ isToday ? 'rp-day-date--today' : '' }}">
                {{ day|date('D d') }}
              </div>

              <div class="d-flex gap-2">
                {# ✅ bouton loupe => ouvre le picker #}
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm"
                  title="Choisir une recette"
                  aria-label="Choisir une recette"
                  data-action="recipe-picker#open"
                  data-recipe-picker-date-param="{{ dayKey }}"
                >
                  <i class="fa-solid fa-magnifying-glass"></i>
                </button>

                {# bouton proposer (existant) #}
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm rp-day-propose-btn"
                  title="Proposer un repas pour ce jour"
                  aria-label="Proposer un repas"
                  data-action="day-propose#propose"
                  data-day-propose-target="button"
                >
                  <i class="fa-solid fa-wand-magic-sparkles"></i>
                </button>
              </div>
            </div>

            <div class="d-flex flex-column gap-2 meal-list" data-day-propose-target="meals">
              {% if meals is empty %}
                <div class="text-body-secondary small fst-italic" data-day-propose-target="empty">
                  Aucun repas planifié
                </div>
              {% else %}
                {% for meal in meals %}
                  {% set recipeId = meal.recipe ? meal.recipe.id : null %}
                  {% set ok = recipeId ? (feasibleByRecipeId[recipeId] ?? true) : true %}

                  {{ include('mealplan/_meal_item.html.twig', {
                    meal: meal,
                    is_feasible: ok,
                    swipe_hint: (isToday and hintMealId is not null and meal.id == hintMealId)
                  }) }}
                {% endfor %}
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>
