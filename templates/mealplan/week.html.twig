{# templates/mealplan/week.html.twig #}
<section class="card shadow-sm" data-week-start="{{ weekStart|date('Y-m-d') }}">
  <div class="card-header d-flex justify-content-between align-items-center">
    <div class="fw-semibold">
      Semaine {{ weekStart|date('W') }} — {{ weekStart|date('d/m') }} → {{ weekEnd|date('d/m') }}
    </div>
    <div class="text-body-secondary small">
      {{ weekStart|date('Y-m-d') }}
    </div>
  </div>

  <div class="card-body">
    <div class="list-group list-group-flush">
      {% for i in 0..6 %}
        {% set day = weekStart|date_modify('+' ~ i ~ ' days') %}
        {% set dayKey = day|date('Y-m-d') %}
        {% set isToday = dayKey == today|date('Y-m-d') %}
        {% set isPast = day < today %}
        {% set meals = planningByDate[dayKey] ?? [] %}

        <div class="list-group-item px-0"
             data-controller="day-propose"
             data-day-propose-url-value="{{ path('meal_plan_propose_ajax') }}"
             data-day-propose-date-value="{{ dayKey }}"
             data-day-propose-csrf-value="{{ csrf_token('mealplan_propose') }}"
             data-day-key="{{ dayKey }}"
        >
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">
              {{ day|date('l d/m/Y') }}
              {% if isToday %}
                <span class="badge text-bg-primary ms-2">Aujourd’hui</span>
              {% elseif isPast %}
                <span class="badge text-bg-secondary ms-2">Passé</span>
              {% else %}
                <span class="badge text-bg-success ms-2">À venir</span>
              {% endif %}
            </div>

            <div class="d-flex align-items-center gap-2">
              <div class="text-body-secondary small">
                {{ meals|length }} repas
              </div>

              <button type="button"
                      class="btn btn-sm btn-outline-primary"
                      title="Proposer un repas pour ce jour"
                      data-action="day-propose#propose"
                      data-day-propose-target="button">
                + Proposer
              </button>
            </div>
          </div>

          {# ✅ Conteneur cible pour insertion AJAX #}
          <div class="d-flex flex-column gap-2" data-day-propose-target="meals">
            {% if meals is empty %}
              <div class="text-body-secondary small fst-italic" data-day-propose-target="empty">
                Aucun repas planifié
              </div>
            {% else %}
              {% for meal in meals %}
                {# ✅ IMPORTANT : on utilise le partial pour garantir data-meal-id etc. #}
                {{ include('mealplan/_meal_item.html.twig', { meal: meal }) }}
              {% endfor %}
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</section>
