# yaml-language-server: $schema=../vendor/symfony/dependency-injection/Loader/schema/services.schema.json

parameters:
  openai.api_key: '%env(OPENAI_API_KEY)%'
  cron.secret: '%env(CRON_SECRET)%'

services:
  _defaults:
    autowire: true
    autoconfigure: true

  # ✅ Auto-tag de toutes les actions IA (plus besoin de déclarer chaque AiAction une par une)
  _instanceof:
    App\Service\Ai\Action\AiActionInterface:
      tags: ['app.ai_action']

  # Auto-register de tout le code App\
  App\:
    resource: '../src/'
    exclude:
      - '../src/DependencyInjection/'
      - '../src/Entity/'
      - '../src/Kernel.php'

  # Controllers
  App\Controller\:
    resource: '../src/Controller/'
    tags: ['controller.service_arguments']

  # ----------------------------
  # AWS S3 client for Cloudflare R2
  # ----------------------------
  Aws\S3\S3Client:
    arguments:
      - version: 'latest'
        region: 'auto'
        endpoint: '%env(resolve:R2_ENDPOINT)%'
        use_path_style_endpoint: true
        credentials:
          key: '%env(R2_ACCESS_KEY)%'
          secret: '%env(R2_SECRET_KEY)%'

  receiplan.r2_adapter:
    class: League\Flysystem\AwsS3V3\AwsS3V3Adapter
    arguments:
      - '@Aws\S3\S3Client'
      - '%env(R2_BUCKET)%'

  receiplan.r2_filesystem:
    class: League\Flysystem\Filesystem
    arguments:
      - '@receiplan.r2_adapter'

  App\Service\Image\Storage\R2ImageStorage:
    arguments:
      $fs: '@receiplan.r2_filesystem'
      $publicBaseUrl: '%env(resolve:R2_PUBLIC_BASE_URL)%'

  App\Service\Image\Storage\ImageStorageInterface: '@App\Service\Image\Storage\R2ImageStorage'

  # Resolvers images
  App\Service\IngredientImageResolver: ~
  App\Service\RecipeImageResolver: ~

  # ----------------------------
  # AI Services
  # ----------------------------
  App\Service\Ai\AiTranscriptionService:
    arguments:
      $openAiApiKey: '%env(OPENAI_API_KEY)%'
      $model: 'whisper-1'

  # ⚠️ IMPORTANT :
  # Ce service correspond à ta classe "App\Service\AiTicketParser" (namespace App\Service)
  # Si ton controller type-hinte "App\Service\Ai\AiTicketParser", il faut corriger le controller,
  # pas ce service.
  App\Service\AiTicketParser:
    arguments:
      $openAiApiKey: '%env(OPENAI_API_KEY)%'
      $model: 'gpt-4.1-mini'

  App\Service\AiImageClient:
    arguments:
      $openAiApiKey: '%env(OPENAI_API_KEY)%'

  # OpenAI structured client (Responses API)
  App\Service\Ai\OpenAi\OpenAiStructuredClient:
    arguments:
      $openAiApiKey: '%env(OPENAI_API_KEY)%'
      $model: 'gpt-4.1-mini'

  # Registry des actions IA (alimenté par le tag app.ai_action)
  App\Service\Ai\Action\ActionRegistry:
    arguments:
      $actions: !tagged_iterator app.ai_action

  # ----------------------------
  # Push / Cron
  # ----------------------------
  App\Service\PushActionTokenService:
    arguments:
      $secret: '%env(CRON_SECRET)%'
